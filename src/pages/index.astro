---
import homeService from "@services/homeService";
import azListService from "@services/azListService";
import genreService from "@services/genreService";
import animeConfig from "@configs/animeConfig";
import Sesepuh from "@components/Sesepuh.astro";
import Layout from "@layouts/Layout.astro";
import WidgetTitle from "@components/WidgetTitle.astro";
import Carousel from "@components/Carousel.astro";
import Breadcrumb from "@components/Breadcrumb.astro";
import Content from "@components/Content.astro";
import Sidebar from "@components/Sidebar.astro";
import AnimeList1 from "@components/AnimeList1.astro";
import Error from "@components/Error.astro";
import generateUrlPath from "@utils/generateUrlPath";

const config = (animeConfig as any).default || animeConfig;
const {
  sankadonghub: { siteName, description, image },
} = config;
const home = await homeService();
const { ok, data, statusCode, message, statusMessage } = home;
const azData = await azListService();
const azList = azData.ok ? azData.data.az_list_letters : [];
const genreData = await genreService();
const allGenres = genreData.ok ? genreData.data.genreList : [];
const seasonList = allGenres.filter(g => /^\d{4}|spring|summer|fall|winter/i.test(g.title)).sort((a, b) => b.title.localeCompare(a.title));
const genreListOnly = allGenres.filter(g => !/^\d{4}|spring|summer|fall|winter/i.test(g.title));
---

{
  !ok ? (
    <Error statusCode={statusCode} message={message || statusMessage} />
  ) : (
    <Layout
      seo={{
        title: `${siteName} - Nonton Streaming & Download anime Sub Indo Gratis`,
        description,
        openGraph: {
          basic: {
            title: `${siteName}`,
            image: `${Astro.url.origin + image}`,
            type: "website",
          },
        },
      }}
    >
      <Carousel
        anime={{
          list: data.recent.animeList.slice(0, 5),
          baseUrlPath: "/episode", 
        }}
      />
      <Breadcrumb />
  
      <Sesepuh>
        <Content>
          <WidgetTitle title="Episode Terbaru" href="/recent" />
          <AnimeList1 
            anime={{ 
              list: data.recent.animeList, 
              baseUrlPath: "/episode" 
            }} 
          />
          
          <WidgetTitle title="Download Batch Donghua" href="/batch" />
          <AnimeList1 
            anime={{ 
              list: data.batch.batchList, 
              baseUrlPath: "/batch" 
            }} 
          />
        </Content>
        <Sidebar>
            <WidgetTitle title="Seasons" />
            <div class="flex flex-wrap gap-2 mb-6 max-h-60 overflow-y-auto pr-1 custom-scrollbar">
                {seasonList.map((season) => (
                    <a href={generateUrlPath("/genres", season.genreId)} class="text-xs font-medium px-2.5 py-1.5 rounded bg-zinc-200 text-zinc-800 hover:bg-amber-600 hover:text-white dark:bg-zinc-800 dark:text-zinc-200 dark:hover:bg-amber-600 transition-colors">
                        {season.title}
                    </a>
                ))}
            </div>
            <WidgetTitle title="Daftar Genre" />
            <div class="flex flex-wrap gap-2 mb-6 max-h-60 overflow-y-auto pr-1 custom-scrollbar">
                {genreListOnly.map((genre) => (
                    <a href={generateUrlPath("/genres", genre.genreId)} class="text-xs font-medium px-2.5 py-1.5 rounded bg-zinc-200 text-zinc-800 hover:bg-amber-600 hover:text-white dark:bg-zinc-800 dark:text-zinc-200 dark:hover:bg-amber-600 transition-colors">
                        {genre.title}
                    </a>
                ))}
            </div>
            <WidgetTitle title="A-Z List" />
            <div class="flex flex-wrap gap-2 max-h-60 overflow-y-auto pr-1 custom-scrollbar">
                {azList.map((item) => (
                    <a href={generateUrlPath("/az-list", item.slug)} class="w-8 h-8 flex items-center justify-center text-sm font-bold rounded bg-zinc-200 text-zinc-800 hover:bg-sky-600 hover:text-white dark:bg-zinc-800 dark:text-zinc-200 dark:hover:bg-sky-600 transition-colors">
                        {item.letter}
                    </a>
                ))}
            </div>
        </Sidebar>
      </Sesepuh>
    </Layout>
  )
}